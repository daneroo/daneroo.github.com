--- 
name: growing-a-raid5-array
layout: post
title: Growing a raid5 array
time: 2006-10-06 14:21:00.002000 -04:00
tags: []

---
Grow a raid5 array from 3 disks to 4.<br /><br />mdadm - lvm(2) - evm - extfs<br /><br />A- Growing a raid5 directly<br /> get mdadm 2.5.2 or above <br /> -found http://www.cse.unsw.edu.au/~neilb/source/mdadm/RPM/mdadm-2.5.3-1.i386.rpm<br />confir kernel >2.6.17<br /><br />first create 4 devices in vmware. /dev/sd[bdce]1<br />mdadm --create --verbose /dev/md0 -l5 -n3 /dev/sdb1 /dev/sdc1 /dev/sdd1<br /># how big does the backup file need to be?<br />mdadm --grow /dev/md0 -n4 --backup-file=/tmp/raidbackup<br />mdadm -a /dev/md0 /dev/sde1<br /><br />Then redo this with a filesystem on /dev/md0, or better ext3fs over lvm over /dev/md0<br /><br />B- Alternatively using multiple raid5 pv's we can simply grow each pv independantly:<br />    * pvmove /dev/md3 # Move all data off of /dev/md3<br />   * vgreduce vg /dev/md3 # Remove /dev/md3 from the volume group<br />   * pvremove /dev/md3 # Remove the LVM signature from /dev/md3<br />   * mdadm --stop /dev/md3 # Stop the array<br />   * mdadm --zero-superblock /dev/md3 # Remove the md signature from the disk<br />   * mdadm --create /dev/md3 --level=5 --raid-devices=4 /dev/hda3 /dev/hdc3 /dev/hde3 /dev/hdg3 # Create the new array<br />   * pvcreate /dev/md3 # Prepare /dev/md3 for LVM use<br />   * vgextend vg /dev/md3 # Add /dev/md3 into the array<br /><br />---- found this enabling note---<br />http://www.gagme.com/greg/linux/raid-lvm.php<br />For those now reading this, you can actually expand a raid 5 array with mdadm for software based raid in linux.  At least as of kernel 2.6.17 and mdadm 2.5.2 it is possible.  One easy way to stest this is to create 4 files with dd, I created 4 100MB files named raidfile[1-4].  Next, use losetup to set them up as loop back devices, I used loop[0-3]. To create the initial array do:<br />mdadm --create --verbose /dev/md0 -l5 -n3 /dev/loop0 /dev/loop1 /dev/loop2<br />The array should now be initializing, when it is finished, increase the number of raid devices in the array by issuing the command:<br />mdadm --grow /dev/md0 -n4 --backup-file=/tmp/raidbackup<br />This part requires a backup file in case power is lost during the reordering of data, this backup file has to be used to assemble the raid array in that case.<br />Next, to add the other drive to the array use:<br />mdadm -a /dev/md0 /dev/loop4<br />the new drive will then be added to the array with no data lose hopefully.  During my testing it has worked flawlessly so far, but as for using it on a  production box its probably not recommended unless you have backups.  You do keep backups correct? <br />--------------------------------------------------
